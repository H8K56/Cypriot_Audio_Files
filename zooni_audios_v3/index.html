import os
from pathlib import Path
import re

AUDIO_DIR = "zooni_audios_v3"
OUTPUT_FILE = os.path.join(AUDIO_DIR, "index.html")
EXTENSIONS = [".mp3"]  # Add more as needed

def build_tree(path):
    tree = {}
    for root, dirs, files in os.walk(path):
        rel_root = os.path.relpath(root, AUDIO_DIR)
        rel_root = "" if rel_root == "." else rel_root
        sub_tree = tree
        if rel_root:
            for part in rel_root.split(os.sep):
                sub_tree = sub_tree.setdefault(part, {})
        for file in files:
            if Path(file).suffix.lower() in EXTENSIONS:
                sub_tree.setdefault("__files__", []).append(file)
    return tree

def natural_key(s):
    # Split string into parts: digits as integers, others as lowercase strings
    parts = re.split(r'(\d+)', s)
    return [int(p) if p.isdigit() else p.lower() for p in parts]

def render_tree(tree, parent_path=""):
    html = "<ul>\n"
    # Sort folders naturally
    for name, subtree in sorted(tree.items(), key=lambda x: natural_key(x[0])):
        if name == "__files__":
            # Sort files naturally
            for f in sorted(subtree, key=natural_key):
                full_path = os.path.join(parent_path, f)
                html += f'<li><a href="{full_path}" download>{f}</a></li>\n'
        else:
            path = os.path.join(parent_path, name)
            html += f'<li><details><summary>{name}</summary>\n{render_tree(subtree, path)}</details></li>\n'
    html += "</ul>\n"
    return html

tree = build_tree(AUDIO_DIR)
html_body = render_tree(tree)

html_template = f"""<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Audio Downloads</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    ul { list-style-type: none; }
    a { text-decoration: none; color: #0366d6; }
    a:hover { text-decoration: underline; }
    details > summary { cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Cypriot Audio Files</h1>
  {html_body}
</body>
</html>
"""

with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    f.write(html_template)

print(f"âœ… index.html generated with collapsible folders at: {OUTPUT_FILE}")
